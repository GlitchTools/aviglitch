#!/usr/bin/env ruby
# Generate datamoshing

require 'optparse'
require 'rubygems'
require 'aviglitch'

output = './out.avi'
all = false

opts = OptionParser.new do |opts|
  opts.banner = "datamosh - AviGlitch's datamoshing video generator."
  opts.define_head "Usage: #{File.basename($0)} <input> [options]"
  opts.separator "Options:"
  opts.on("-o", "--output [OUTPUT]", 
    "Output the video to OUTPUT (./out.avi by default)") do |f|
    output = f
  end
  opts.on("-a", "--all", 
    "Remove all keyframes (It remains a first keyframe by default)") do
    all = true
  end
  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end

input = opts.parse!
if input.empty?
  puts opts
  exit 1
end

ag = nil
input.each do |file|
  a = AviGlitch.open file
  a.glitch_with_index :keyframe do |frame, i|
    if !all && ag.nil? && i == 0  # keep the first frame
      frame
    else
      "\000" * frame.size
    end
  end
  if ag.nil?
    ag = a
  else
    ag.frames.concat a.frames
  end
end

ag.output(output)

